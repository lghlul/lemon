<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.demo.dao.TeacherClassDao">


    <insert id="save" parameterType="teacherClassDTO" keyProperty="teacherClassId" useGeneratedKeys="true">
    insert into teacherClass(teacherId , classId  , createTime , term) values( #{teacherId} , #{classId}  , #{createTime} , #{term})
   </insert>
    <update id="update" parameterType="teacherClassDTO">
        update teacherClass
        <set>
            <if test="teacherId != null">
                teacherId = #{teacherId},
            </if>
            <if test="classId != null">
                classId = #{classId},
            </if>
            <if test="term != null">
                term = #{term},
            </if>
        </set>
        where teacherClassId = #{teacherClassId}
    </update>


    <select id="get" parameterType="getTeacherClassDTO" resultType="teacherClass">
        select * from teacherClass
        <where>
            <if test="teacherNumber != null">
                and teacherNumber = #{teacherNumber}
            </if>
            <if test="classNumber != null">
                and classNumber = #{classNumber}
            </if>
            <if test="term != null">
                and term = #{term}
            </if>
            <if test="teacherClassId != null">
                and teacherClassId = #{teacherClassId}
            </if>
        </where>
    </select>


    <select id="list" parameterType="listTeacherClassDTO" resultType="listTeacherClassDTO">
        select a.*,c.* from teacher a , teacherClass b , classInfo c where a.teacherId = b.teacherId and
        b.classId = c.classId
    </select>

    <select id="listClass" parameterType="int" resultType="listTeacherClassByTermDTO">
        SELECT
        m.*, n.className
        FROM
        (
        SELECT
        term,
        max(score) maxScore,
        min(score) minScore,
        AVG(score) avgScore,
        classId
        FROM
        teacherClass a
        JOIN studentClass b ON a.teacherClassId = b.teacherClassId
        <where>
            <if test="teacherId != null">
                and teacherId = #{teacherId}
            </if>
        </where>
        GROUP BY
        term,
        classId
        ) m
        JOIN classInfo n ON m.classId = n.classId
    </select>


    <select id="listTeacherByTeacherLevel" resultType="listTeacherClassScoreDTO">
        SELECT
            m.*, n.className,t.teacherName
        FROM
            (
                SELECT
                    teacherId,
                    max(score) maxScore,
                    min(score) minScore,
                    AVG(score) avgScore,
                    classId
                FROM
                    teacherClass a
                JOIN studentClass b ON a.teacherClassId = b.teacherClassId
                GROUP BY
                    teacherId,
                    classId
            ) m
        , classInfo n , teacher t where m.classId = n.classId and m.teacherId = t.teacherId
    </select>


</mapper>
